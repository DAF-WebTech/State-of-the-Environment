<html>

<head>
	<style>
		table,
		thead,
		tr,
		th,
		tbody,
		td,
		tfoot {
			border: 1px black solid;
		}

		th,
		td {
			text-align: left;
		}

		th.num,
		td.num {
			text-align: right
		}
	</style>
	<title>%frontend_asset_name%</title>

</head>

<body>
	<div id=pre>i'm not here</div>



	<script>
		// functions to emulate matrix ssjs
		function print(regionInfo) {
			document.getElementById("pre").innerHTML += regionInfo;
		}

	</script>

	<script id=chartdata type=application/json></script>
	<script src=js/server-render.js> </script>
	<!-- code that goes into matrix server side js block -->
	<script>
		var request = new XMLHttpRequest();
		request.open("GET", "data/indicator-3-4-0-2.csv", false);  // `false` makes the request synchronous
		request.send(null);
		var csv = "";
		if (request.status === 200) {
			csv = request.responseText;
		}


		//%%% start matrix server side %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
		//%%%% var csv = '%frontend_asset_metadata_data-file^as_asset:asset_file_contents^replace:\r\n:\\n%';

		var results = Papa.parse(
			csv,
			{
				skipEmptyLines: true,
				dynamicTyping: true,
				header: true
			}
		);

		var data = results.data;
		var latestYear = results.meta.fields[results.meta.fields.length - 1];
		var keys = results.meta.fields.slice(1);

		///////////////////////////////////////////////////
		var chartData = results.data.map(function (record) {
			return [record.Category, record[latestYear]];
		});
		chartData.unshift(["Category", "Emissions (million tonnes)"]);

		// customise the foot because our data came with it's own foot row and we don't need to calculate it
		var foot = chartData.pop();
		var tfoot = String.format("<tfoot><th scope=row>{0}<th class=num>{1}", foot[0], foot[1].toFixed(3));

 		var index = 0;
		var region = "queensland";
		var heading = "Proportion of Queensland’s stationary energy emissions by category, " + latestYear;
		var htmlTable = tableToHtml(chartData, false, Number.prototype.toFixed, [3]);
		print(String.format(regionInfoTemplate, region, heading, index++, htmlTable.thead, htmlTable.tbody, tfoot));

		var chartItems = [
			{
				data: chartData,
				type: "pie",
				options: getDefaultPieChartOptions(),
			}
		];


		////////////////////////////////////////////////////////////////////////////////
		chartData = results.data.map(function (record) {
			var ret = [record.Category];
			keys.forEach(function (y) {
				ret.push(record[y]);
			});
			return ret;
		});

		var head = ["Category"].concat(keys);
		chartData.unshift(head);
		// customise the foot because our data came with it's own foot row and we don't need to calculate it
		foot = chartData.pop();
		tfoot = "<tfoot><th scope=row>" + foot[0];
		foot.slice(1).forEach(function (f) {
			tfoot += "<th class=num>" + f.toFixed(3);
		})
		heading = "Trends in Queensland’s stationary energy emissions, by category";
		 htmlTable = tableToHtml(chartData, false, Number.prototype.toFixed, [3]);
		print(String.format(regionInfoTemplate, region, heading, index++, htmlTable.thead, htmlTable.tbody, tfoot));
		
		chartData = chartData.transpose();
		var options = getDefaultAreaChartOptions();
		options.isStacked = true;
		options.vAxis.title = "Tonnes (millions)";
		chartItems.push(
			{
				heading: heading,
				data: chartData,
				type: "area",
				options: options,
				foot: foot
			}
		);


		////////////////////////////////////////////////////////////////////////////////
		var arrayTable = [["Year", "Emissions (million tonnes)"]];
		var total = results.data[results.data.length-1];
		keys.forEach(function(y) {
			arrayTable.push([y, total[y]]);
		});

		heading = "Queensland’s total stationary energy emissions";
		htmlTable = tableToHtml(arrayTable, false, Number.prototype.toFixed, [3]);
		print(String.format(regionInfoTemplate, region, heading, index++, htmlTable.thead, htmlTable.tbody));
		



		//%%%% print("<script id=chartdata type=application/json>" + JSON.stringify(chartData) + "</" + "script>");
		//%%%% end matrix server side %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



		document.getElementById("chartdata").textContent = JSON.stringify(chartItems);
//////////////////////////////////////////////////////////////////////////////////////

	</script>
	<script src="https://www.gstatic.com/charts/loader.js"></script>

	<script>

		google.charts.load("current", { packages: ["corechart"] });
		google.charts.setOnLoadCallback(populateIndicatorCharts);

		soejs = {
			chartsLoaded3: function () {
				console.log("chart drawn");
			}
		};

		function populateIndicatorCharts() {

			var chartData = JSON.parse(document.getElementById("chartdata").textContent);
			soejs.num_charts = chartData.length;
			chartData.forEach(function (cd, i) {

				var data = google.visualization.arrayToDataTable(cd.data);

				switch (cd.type) {
					case "pie":
						var chart = new google.visualization.PieChart(document.getElementById("chart_" + i));
						break;
					case "line":
						var chart = new google.visualization.LineChart(document.getElementById("chart_" + i));
						break;
					case "column":
						var chart = new google.visualization.ColumnChart(document.getElementById("chart_" + i));
						break;
					case "bar":
						var chart = new google.visualization.BarChart(document.getElementById("chart_" + i));
						break;
					case "area":
						var chart = new google.visualization.AreaChart(document.getElementById("chart_" + i));
				}


				google.visualization.events.addListener(chart, "ready", soejs.chartsLoaded3);
				chart.draw(data, cd.options);


			});



		}


	</script>
</body>

</html>