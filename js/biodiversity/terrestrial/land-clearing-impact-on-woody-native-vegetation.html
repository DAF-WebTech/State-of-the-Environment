<html>

<head>
	<style>
		table,
		thead,
		tr,
		th,
		tbody,
		td,
		tfoot {
			border: 1px black solid;
		}

		th,
		td {
			text-align: left;
		}

		th.num,
		td.num {
			text-align: right
		}
	</style>
	<title>%frontend_asset_name%</title>

</head>

<body>
	<div id=pre>hello there</div>

	<script>
		function print(regionInfo) {
			document.getElementById("pre").innerHTML += regionInfo;
		}

	</script>
	<script id=chartdata type=application/json> </script>
	<script src=/js/server-render.js> </script>
	<script>
		"use strict";


		var request = new XMLHttpRequest();
		request.open("GET", "/data/indicator-1-1-0-11.csv", false);  // `false` makes the request synchronous
		request.send(null);
		var csv = "";
		if (request.status === 200) {
			csv = request.responseText;
		}


		//%%% start matrix server side %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
		//%%%% var csv = '%frontend_asset_metadata_data-file^as_asset:asset_file_contents^replace:\r\n:\\n%';


		var results = Papa.parse(csv, {
			skipEmptyLines: true,
			dynamicTyping: true
		});

		var data = results.data;

		var region = "Queensland".toKebabCase(); // {0}
		var heading = ""; // {1}
		var index = -1; // {2} use ++index each time
		var thead = ""; // {3}
		var tbody = ""; // {4}
		var tfoot = ""; // {5}
		var chartData = [];




		// fix our first row data
		var years = data[0];
		years = years.slice(2);
		years = years.map(function (year) {
			return year.replace("-", "â€“"); //&ndash; in years
		});



		// chart 1 total clearing
		var heading = "Proportion of total woody vegetation clearing, by bioregion"; // {1}



		// create an 2d array to represent our table
		// head
		var table = [["Region"]];
		table[0] = table[0].concat(years);


		//body
		for (var i = 1; i < data.length; ++i) {
			if (data[i][1] == "Total clearing") {
				var row = [data[i][0]]// region name
				row = row.concat(data[i].slice(2));
				table.push(row);
			}
		}

		// iterate array for our html table
		var tableData = table.transpose();
		var tableHtml = tableToHtml(tableData, false);


		var regionInfo = String.format(regionInfoTemplate, region, heading, ++index, tableHtml.thead, tableHtml.tbody)
		print(regionInfo);



		// transpose for chart
		var chart = {
			data: tableData,
			type: "column"
		};
		chart.data[0][0] = { label: "Year", type: "string" };
		chart.options = getDefaultColumnChartOptions(table.length);
		chart.options.hAxis.title = "Year range";
		chart.options.vAxis.title = "Hectares per year";
		chart.options.isStacked = true;
		chartData.push(chart);




		// chart 2 total clearing type
		heading = "Proportion of replacement landcover (clearing type) "; // {1}
		// get our clearing types
		var excludes = ["Total clearing", "Non-remnant", "Remnant"];
		var clearingTypes = data.slice(1).reduce(function (acc, current) {
			if (excludes.indexOf(current[1]) == -1 && acc.indexOf(current[1]) == -1) {
				acc.push(current[1]);
				return acc;
			}
			else
				return acc;
		}, []);
		// create an 2d array to represent our table
		table = [["Clearing"]];
		table[0] = table[0].concat(years);
		//body
		var empties = years.map(function (y) {
			return null;
		});
		clearingTypes.forEach(function (ct) {
			var row = [ct].concat(empties);
			for (var i = 1; i < data.length; ++i) {
				if (data[i][1] == ct) {
					for (var j = 2; j < data[i].length; ++j) {
						if (data[i][j] != null)
							row[j - 1] += data[i][j];
					}
				}
			}
			table.push(row);
		});

		// iterate array for our html table
		tableHtml = tableToHtml(table.transpose());

		// TODO matrix replace
		regionInfo = String.format(regionInfoTemplate, region, heading, ++index, tableHtml.thead, tableHtml.tbody);
		print(regionInfo);


		// transpose for chart
		chart = {
			data: table.transpose(),
			type: "column"
		};
		chart.data[0][0] = { label: "Year", type: "string" };
		chart.options = getDefaultColumnChartOptions();
		chart.options.hAxis.title = "Year range";
		chart.options.vAxis.title = "Hectares per year";
		chart.options.isStacked = true;
		chartData.push(chart);






		// chart 3
		// remnant, non-remnant
		heading = "Historic woody vegetation clearing in Queensland "; // {1}
		// get our clearing types
		var remnants = data.filter(function(d) { 
			return d[1] == "Remnant" && d[2] != "";
		});
		var nonremnants = data.filter(function(d) { 
			return d[1] == "Non-remnant" && d[2] != "";
		});
		table = [["Year", "Remnant", "Non-remnant"]];
		for (var i = 12; i < data[0].length; ++i) {
			var r = remnants.reduce(function(x, y) {
				return x + y[i];
			}, 0);
			var nr = nonremnants.reduce(function(x, y) {
				return x + y[i];
			}, 0);
			table.push([data[0][i], r, nr]);
		}

		// iterate array for our html table
		tableHtml = tableToHtml(table);

		// TODO matrix replace
		regionInfo = String.format(regionInfoTemplate, region, heading, ++index, tableHtml.thead, tableHtml.tbody)
		print(regionInfo);


		// transpose for chart
		chart = {
			data: table,
			type: "column"
		};
		chart.data[0][0] = { label: "Year", type: "string" };
		chart.options = getDefaultColumnChartOptions();
		chart.options.hAxis.title = "Year range";
		chart.options.vAxis.title = "Clearing rate (hectares per year)";
		chart.options.isStacked = true;
		chartData.push(chart);




		// charts per region
		var regions = data.slice(1).reduce(function (acc, current) {
			if (acc.indexOf(current[0]) == -1) {
				acc.push(current[0]);
				return acc;
			}
			else
				return acc;
		}, []);


		regions.forEach(function (regionName) {

			region = regionName.toKebabCase(); // {0}
			// chart 1 total clearing
			heading = "Proportion of replacement landcover (clearing type) in " + regionName; // {1}
			table = [["Type"]];
			table[0] = table[0].concat(years)

			//body
			for (var i = 1; i < data.length; ++i) {
				if (data[i][0] == regionName && clearingTypes.indexOf(data[i][1]) > -1) {
					var row = [data[i][1]]// clearing type
					row = row.concat(data[i].slice(2));
					table.push(row);
				}
			}

			// iterate array for our html table
			var myTable = table.transpose();
			tableHtml = tableToHtml(myTable);

			regionInfo = String.format(regionInfoTemplate, region, heading, ++index, tableHtml.thead, tableHtml.tbody)
			print(regionInfo);


			// transpose for chart
			chart = {
				data: myTable,
				type: "column"
			};
			chart.data[0][0] = { label: "Year", type: "string" };
			chart.options = getDefaultColumnChartOptions();
			chart.options.hAxis.title = "Year range";
			chart.options.vAxis.title = "Hectares";
			chart.options.isStacked = true;
			chartData.push(chart);


			// chart 2 total clearing


			// chart 1 total clearing
			heading = "Historic woody vegetation clearing in  " + regionName; // {1}
			table = [["Type"]];
			table[0] = table[0].concat(years.slice(10));

			//body
			for (var i = 1; i < data.length; ++i) {
				if (data[i][0] == regionName && (data[i][1] == "Remnant" || data[i][1] == "Non-remnant")) {
					var row = [data[i][1]]// clearing type
					row = row.concat(data[i].slice(12));
					table.push(row);
				}
			}

			// iterate array for our html table
			var myTable = table.transpose();
			tableHtml = tableToHtml(myTable, false);

			regionInfo = String.format(regionInfoTemplate, region, heading, ++index, tableHtml.thead, tableHtml.tbody)
			print(regionInfo);


			// transpose for chart
			chart = {
				data: myTable,
				type: "column"
			};
			chart.data[0][0] = { label: "Year", type: "string" };
			chart.options = getDefaultColumnChartOptions();
			chart.options.hAxis.title = "Year range";
			chart.options.vAxis.title = "Clearing rate (hectares per year)";
			chart.options.isStacked = true;
			chartData.push(chart);



		});


		//%%%% print("<script id=chartdata type=application/json>" + JSON.stringify(chartData) + "</" + "script>");
		//%%%% end matrix server side %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



		document.getElementById("chartdata").textContent = JSON.stringify(chartData);
//////////////////////////////////////////////////////////////////////////////////////

	</script>
	<script src="https://www.gstatic.com/charts/loader.js"></script>
	<script>


		google.charts.load("current", { packages: ["corechart"] });
		google.charts.setOnLoadCallback(populateIndicatorCharts);

		soejs = {
			chartsLoaded3: function () {
				console.log("chart drawn");
			}
		};

		function populateIndicatorCharts() {

			var chartData = JSON.parse(document.getElementById("chartdata").textContent);
			soejs.num_charts = chartData.length;
			chartData.forEach(function (cd, i) {
				var element = document.getElementById("chart_" + i);
				var data = google.visualization.arrayToDataTable(cd.data);
				switch (cd.type) {
					case "area":
						var chart = new google.visualization.AreaChart(element);
						break;
					case "bar":
						var chart = new google.visualization.BarChart(element);
						break;
					case "column":
						var chart = new google.visualization.ColumnChart(element);
						break;
					case "combo":
						var chart = new google.visualization.ComboChart(element);
						break;
					case "line":
						var chart = new google.visualization.LineChart(element);
						break;
					case "pie":
						var chart = new google.visualization.PieChart(element);
						break;
				}

				var data = google.visualization.arrayToDataTable(cd.data);
				chart.draw(data, cd.options);


			});
		}
	</script>
</body>

</html>